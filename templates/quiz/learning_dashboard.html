<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç¿’çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - StudyBoost</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 15px;
        }

        .stat-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            height: 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .level-progress {
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            border-radius: 25px;
            height: 20px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªãƒãƒ£ãƒ¼ãƒˆã‚µã‚¤ã‚º */
        .chart-container canvas {
            max-height: 300px !important;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .nav-buttons {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            transform: scale(1.1);
        }

        .nav-btn.back {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }

        .nav-btn.home {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        .nav-btn.dashboard {
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }

        @media (max-width: 768px) {
            .nav-buttons {
                position: static;
                flex-direction: row;
                justify-content: center;
                margin-bottom: 1rem;
            }
            
            .nav-btn {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body class="bg-light">
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="nav-buttons">
        <button class="nav-btn back" onclick="goBack()" title="å‰ã®ç”»é¢ã«æˆ»ã‚‹">
            <i class="fas fa-arrow-left"></i>
        </button>
        <a href="{% url 'accounts:dashboard' %}" class="nav-btn dashboard" title="ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸">
            <i class="fas fa-home"></i>
        </a>
        <a href="{% url 'home' %}" class="nav-btn home" title="ãƒ›ãƒ¼ãƒ ç”»é¢ã¸">
            <i class="fas fa-th-large"></i>
        </a>
    </div>

    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="dashboard-header text-center">
            <h1 class="display-5 mb-3">
                <i class="fas fa-chart-line me-3"></i>å­¦ç¿’çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
            </h1>
            <p class="lead mb-0">ã‚ãªãŸã®å­¦ç¿’æˆæœã‚’è©³ã—ãåˆ†æ</p>
            <small class="opacity-75">Level {{ overall_stats.level }} | çµŒé¨“å€¤ {{ overall_stats.experience }}pt</small>
        </div>

        <!-- å…¨ä½“çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stat-card border-primary">
                    <div class="card-body text-center">
                        <i class="fas fa-trophy fa-2x text-primary mb-2"></i>
                        <h4 class="card-title">Lv.{{ overall_stats.level }}</h4>
                        <p class="card-text text-muted">ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«</p>
                        <div class="level-progress mt-2">
                            <div class="progress-bar" style="width: {{ level_progress.progress_percentage|default:50 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stat-card border-success">
                    <div class="card-body text-center">
                        <i class="fas fa-bullseye fa-2x text-success mb-2"></i>
                        <h4 class="card-title">{{ overall_stats.accuracy }}%</h4>
                        <p class="card-text text-muted">å¹³å‡æ­£ç­”ç‡</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stat-card border-info">
                    <div class="card-body text-center">
                        <i class="fas fa-question-circle fa-2x text-info mb-2"></i>
                        <h4 class="card-title">{{ overall_stats.total_quizzes }}</h4>
                        <p class="card-text text-muted">å®Œäº†ã‚¯ã‚¤ã‚ºæ•°</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stat-card border-warning">
                    <div class="card-body text-center">
                        <i class="fas fa-calendar-day fa-2x text-warning mb-2"></i>
                        <h4 class="card-title">{{ overall_stats.learning_days }}</h4>
                        <p class="card-text text-muted">å­¦ç¿’æ—¥æ•°</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- é€²æ—ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆï¼ˆéå»7æ—¥é–“ï¼‰ -->
        <div class="chart-container">
            <h5><i class="fas fa-chart-area me-2"></i>å­¦ç¿’é€²æ—ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆéå»7æ—¥é–“ï¼‰</h5>
            <canvas id="progressChart" height="120"></canvas>
        </div>

        <!-- åˆ†é‡åˆ¥æˆç¸¾ã¨å¼±ç‚¹åˆ†æ -->
        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-bar me-2"></i>å‹•ç”»åˆ¥æˆç¸¾ï¼ˆä¸Šä½5ä»¶ï¼‰</h5>
                    {% if video_performance %}
                        {% for video in video_performance %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>{{ video.quiz__video__title|truncatechars:30 }}</span>
                                <span class="fw-bold">{{ video.accuracy|floatformat:1 }}% ({{ video.total }}å•)</span>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar 
                                    {% if video.accuracy >= 80 %}bg-success
                                    {% elif video.accuracy >= 60 %}bg-warning  
                                    {% else %}bg-danger{% endif %}" 
                                    style="width: {{ video.accuracy }}%">
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-lg-4 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-exclamation-triangle me-2 text-warning"></i>å¼±ç‚¹åˆ†æ</h5>
                    {% if weakness_analysis %}
                        {% for weakness in weakness_analysis %}
                        <div class="alert alert-warning mb-2">
                            <h6>{{ weakness.topic|truncatechars:25 }}</h6>
                            <p class="mb-1">æ­£ç­”ç‡: {{ weakness.accuracy|floatformat:1 }}%</p>
                            <small>{{ weakness.suggestion }}</small>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-success">
                            <i class="fas fa-star me-2"></i>
                            ç¾åœ¨ã€ç‰¹ã«å¼±ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ï¼<br>
                            ç´ æ™´ã‚‰ã—ã„æˆç¸¾ã§ã™ã€‚
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- æœ€è¿‘ã®å±¥æ­´ -->
        {% if recent_histories %}
        <div class="chart-container">
            <h5><i class="fas fa-history me-2"></i>æœ€è¿‘ã®å­¦ç¿’å±¥æ­´ï¼ˆç›´è¿‘10ä»¶ï¼‰</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>å‹•ç”»</th>
                            <th>å•é¡Œ</th>
                            <th>çµæœ</th>
                            <th>æ—¥æ™‚</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for history in recent_histories %}
                        <tr>
                            <td>{{ history.quiz.video.title|truncatechars:25 }}</td>
                            <td>{{ history.quiz.question|truncatechars:35 }}</td>
                            <td>
                                {% if history.is_correct %}
                                    <span class="badge bg-success">æ­£è§£</span>
                                {% else %}
                                    <span class="badge bg-danger">ä¸æ­£è§£</span>
                                {% endif %}
                            </td>
                            <td class="text-muted small">{{ history.answered_at|date:"m/d H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="text-center mt-3">
                <a href="{% url 'quiz:quiz_history' %}" class="btn btn-outline-primary">
                    <i class="fas fa-list me-2"></i>å…¨å±¥æ­´ã‚’è¦‹ã‚‹
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
    // æˆ»ã‚‹ãƒœã‚¿ãƒ³æ©Ÿèƒ½
    function goBack() {
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.location.href = "{% url 'accounts:dashboard' %}";
        }
    }

    // é€²æ—ãƒãƒ£ãƒ¼ãƒˆï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆï¼‰
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('progressChart');
        if (!ctx) {
            console.log('âš ï¸ progressChartè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }
        
        const progressData = {{ chart_data.progress_trend|safe }};
        
        new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: progressData.map(item => item.date),
                datasets: [{
                    label: 'æ­£è§£æ•°',
                    data: progressData.map(item => item.correct),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'æ—¥ã€…ã®æ­£è§£æ•°æ¨ç§»'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    }
                },
                elements: {
                    point: {
                        hoverRadius: 8
                    }
                }
            }
        });
        
        console.log('ğŸ“Š å­¦ç¿’çµ±è¨ˆãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–å®Œäº†');
    });

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    document.addEventListener('keydown', function(e) {
        // Escã‚­ãƒ¼ã§æˆ»ã‚‹
        if (e.key === 'Escape') {
            goBack();
        }
        // Hã‚­ãƒ¼ã§ãƒ›ãƒ¼ãƒ 
        if (e.key === 'h' || e.key === 'H') {
            window.location.href = "{% url 'home' %}";
        }
        // Dã‚­ãƒ¼ã§ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        if (e.key === 'd' || e.key === 'D') {
            window.location.href = "{% url 'accounts:dashboard' %}";
        }
    });

    console.log('ğŸ“Š å­¦ç¿’çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èª­ã¿è¾¼ã¿å®Œäº†');
    console.log('ğŸ¯ ãƒ¬ãƒ™ãƒ«:', {{ overall_stats.level }});
    console.log('ğŸ“ˆ æ­£ç­”ç‡:', {{ overall_stats.accuracy }},'%');
    console.log('ğŸ“… ãƒˆãƒ¬ãƒ³ãƒ‰æœŸé–“: éå»7æ—¥é–“ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºï¼‰');
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>