<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¯ã‚¤ã‚ºå®Ÿè¡Œ - StudyBoost</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .question-card {
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 15px;
        }
        .option-btn {
            width: 100%;
            text-align: left;
            padding: 15px 20px;
            margin-bottom: 10px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .option-btn:hover {
            border-color: #007bff;
            background: #f8f9ff;
            transform: translateY(-2px);
        }
        .option-btn.selected {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }
        .progress-custom {
            height: 8px;
            border-radius: 10px;
        }
        .quiz-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        .submit-answer-btn {
            transition: all 0.3s ease;
        }
        .submit-answer-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <div class="quiz-container">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="card question-card mb-4">
                <div class="card-header quiz-header text-center py-4">
                    <h3 class="mb-2">
                        <i class="fas fa-question-circle me-2"></i>
                        ã‚¯ã‚¤ã‚ºãƒãƒ£ãƒ¬ãƒ³ã‚¸
                    </h3>
                    <h6 class="mb-0 opacity-75">{{ video.title }}</h6>
                </div>
                <div class="card-body">
                    <!-- é€²æ—ãƒãƒ¼ -->
                    <div class="row align-items-center mb-3">
                        <div class="col-8">
                            <div class="progress progress-custom">
                                <div class="progress-bar bg-success" 
                                     role="progressbar" 
                                     style="width: 0%" 
                                     id="progressBar">
                                </div>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <span class="badge bg-primary fs-6" id="questionCounter">
                                1 / {{ total_questions }}
                            </span>
                        </div>
                    </div>
                    
                    <!-- ã‚¹ã‚³ã‚¢è¡¨ç¤º -->
                    <div class="text-center">
                        <span class="badge bg-success me-2">
                            <i class="fas fa-star me-1"></i>
                            ã‚¹ã‚³ã‚¢: <span id="currentScore">0</span>
                        </span>
                        <span class="badge bg-info">
                            <i class="fas fa-clock me-1"></i>
                            æ®‹ã‚Š: <span id="remainingQuestions">{{ total_questions }}</span>å•
                        </span>
                    </div>
                </div>
            </div>

            <!-- ã‚¯ã‚¤ã‚ºå•é¡Œã‚¨ãƒªã‚¢ -->
            <div id="quizContainer">
                {% for quiz in quizzes %}
                <div class="card question-card quiz-question" 
                     data-quiz-id="{{ quiz.id }}" 
                     data-question-number="{{ forloop.counter }}"
                     style="{% if not forloop.first %}display: none;{% endif %}">
                    
                    <div class="card-body p-4">
                        <!-- å•é¡Œç•ªå· -->
                        <div class="text-center mb-3">
                            <span class="badge bg-warning text-dark fs-6">
                                å•é¡Œ {{ forloop.counter }}
                            </span>
                        </div>
                        
                        <!-- å•é¡Œæ–‡ -->
                        <h5 class="card-title text-center mb-4 fw-bold">
                            {{ quiz.question }}
                        </h5>
                        
                        <!-- é¸æŠè‚¢ -->
                        <div class="options-container">
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <button class="btn option-btn" data-option="1">
                                        <span class="fw-bold me-2">A.</span>
                                        {{ quiz.option_1 }}
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button class="btn option-btn" data-option="2">
                                        <span class="fw-bold me-2">B.</span>
                                        {{ quiz.option_2 }}
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button class="btn option-btn" data-option="3">
                                        <span class="fw-bold me-2">C.</span>
                                        {{ quiz.option_3 }}
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button class="btn option-btn" data-option="4">
                                        <span class="fw-bold me-2">D.</span>
                                        {{ quiz.option_4 }}
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å›ç­”ãƒœã‚¿ãƒ³ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚¯ãƒ©ã‚¹åã‚’ä½¿ç”¨ï¼‰ -->
                        <div class="text-center mt-4">
                            <button class="btn btn-primary btn-lg px-5 submit-answer-btn" 
                                    data-question-id="{{ forloop.counter }}"
                                    disabled>
                                <i class="fas fa-check me-2"></i>
                                å›ç­”ã™ã‚‹
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="resultContainer" style="display: none;">
                <div class="card question-card">
                    <div class="card-body text-center p-5">
                        <div id="resultIcon" class="mb-3">
                            <!-- ã‚¢ã‚¤ã‚³ãƒ³ãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                        </div>
                        <h4 id="resultTitle" class="mb-3"></h4>
                        <p id="resultExplanation" class="text-muted mb-4"></p>
                        <button class="btn btn-success btn-lg" id="nextQuestion">
                            <i class="fas fa-arrow-right me-2"></i>
                            <span id="nextBtnText">æ¬¡ã®å•é¡Œã¸</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- å®Œäº†ãƒœã‚¿ãƒ³ -->
            <div class="text-center mt-4">
                <a href="/accounts/dashboard/" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
                </a>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% csrf_token %}
    
    <script>
    // ã‚¯ã‚¤ã‚ºç®¡ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    const QuizManager = {
        currentQuestion: 1,
        totalQuestions: {{ total_questions }},
        score: 0,
        selectedOption: null,
        videoId: {{ video.id }},
        
        init() {
            console.log('ğŸ¯ ã‚¯ã‚¤ã‚ºé–‹å§‹ - ç·å•é¡Œæ•°:', this.totalQuestions);
            this.bindEvents();
            this.updateProgress();
        },
        
        bindEvents() {
            // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã‚’ä½¿ç”¨
            document.addEventListener('click', (e) => {
                // é¸æŠè‚¢ã‚¯ãƒªãƒƒã‚¯
                if (e.target.classList.contains('option-btn') || e.target.closest('.option-btn')) {
                    const optionBtn = e.target.classList.contains('option-btn') 
                        ? e.target 
                        : e.target.closest('.option-btn');
                    this.selectOption(optionBtn);
                }
                
                // å›ç­”ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚¯ãƒ©ã‚¹åã§åˆ¤å®šï¼‰
                if (e.target.classList.contains('submit-answer-btn') || e.target.closest('.submit-answer-btn')) {
                    e.preventDefault();
                    this.submitAnswer();
                }
                
                // æ¬¡ã®å•é¡Œãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
                if (e.target.id === 'nextQuestion' || e.target.closest('#nextQuestion')) {
                    e.preventDefault();
                    this.nextQuestion();
                }
            });
        },
        
        selectOption(optionBtn) {
            // ç¾åœ¨è¡¨ç¤ºä¸­ã®å•é¡Œã®é¸æŠè‚¢ã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹
            const currentQuizCard = document.querySelector('.quiz-question:not([style*="display: none"])');
            if (!currentQuizCard) return;
            
            const currentOptions = currentQuizCard.querySelectorAll('.option-btn');
            
            // ç¾åœ¨ã®å•é¡Œã®é¸æŠè‚¢ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            currentOptions.forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // æ–°ã—ã„é¸æŠã‚’è¨­å®š
            optionBtn.classList.add('selected');
            this.selectedOption = optionBtn.dataset.option;
            
            // ç¾åœ¨ã®å•é¡Œã®å›ç­”ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            const currentSubmitBtn = currentQuizCard.querySelector('.submit-answer-btn');
            if (currentSubmitBtn) {
                currentSubmitBtn.disabled = false;
            }
            
            console.log('âœ… é¸æŠè‚¢é¸æŠ:', this.selectedOption);
        },
        
        async submitAnswer() {
            if (!this.selectedOption) {
                alert('é¸æŠè‚¢ã‚’é¸ã‚“ã§ãã ã•ã„');
                return;
            }
            
            const currentQuizCard = document.querySelector('.quiz-question:not([style*="display: none"])');
            if (!currentQuizCard) return;
            
            const quizId = currentQuizCard.dataset.quizId;
            
            // å›ç­”ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆé€£ç¶šã‚¯ãƒªãƒƒã‚¯é˜²æ­¢ï¼‰
            const submitBtn = currentQuizCard.querySelector('.submit-answer-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>é€ä¿¡ä¸­...';
            }
            
            console.log('ğŸ“¤ å›ç­”é€ä¿¡:', { quizId, selectedOption: this.selectedOption });
            
            try {
                const response = await fetch(`/quiz/submit/${this.videoId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        quiz_id: quizId,
                        selected_option: this.selectedOption
                    })
                });
                
                const data = await response.json();
                console.log('ğŸ“¥ å›ç­”çµæœ:', data);
                
                if (data.success) {
                    this.showResult(data);
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’å¾©å…ƒ
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>å›ç­”ã™ã‚‹';
                    }
                }
                
            } catch (error) {
                console.error('âŒ å›ç­”é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’å¾©å…ƒ
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>å›ç­”ã™ã‚‹';
                }
            }
        },
        
        showResult(data) {
            console.log('ğŸ“Š çµæœè¡¨ç¤º:', data);
            
            // å•é¡Œã‚’éè¡¨ç¤º
            document.getElementById('quizContainer').style.display = 'none';
            
            // çµæœã‚’è¡¨ç¤º
            const resultContainer = document.getElementById('resultContainer');
            const resultIcon = document.getElementById('resultIcon');
            const resultTitle = document.getElementById('resultTitle');
            const resultExplanation = document.getElementById('resultExplanation');
            const nextBtnText = document.getElementById('nextBtnText');
            
            if (data.is_correct) {
                resultIcon.innerHTML = '<i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>';
                resultTitle.innerHTML = '<span class="text-success">æ­£è§£ï¼</span>';
                resultTitle.className = 'mb-3 text-success';
                this.score++;
            } else {
                resultIcon.innerHTML = '<i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>';
                resultTitle.innerHTML = '<span class="text-danger">ä¸æ­£è§£</span>';
                resultTitle.className = 'mb-3 text-danger';
                
                // æ­£è§£ã®é¸æŠè‚¢ã‚’è¡¨ç¤º
                const correctOptionText = this.getCorrectOptionText(data.correct_option);
                resultTitle.innerHTML += `<br><small class="text-muted">æ­£è§£: ${correctOptionText}</small>`;
            }
            
            resultExplanation.textContent = data.explanation;
            
            // æœ€å¾Œã®å•é¡Œã‹ã©ã†ã‹ã§ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
            if (this.currentQuestion >= this.totalQuestions) {
                nextBtnText.innerHTML = '<i class="fas fa-trophy me-2"></i>çµæœã‚’è¦‹ã‚‹';
            } else {
                nextBtnText.innerHTML = 'æ¬¡ã®å•é¡Œã¸';
            }
            
            resultContainer.style.display = 'block';
            
            // ã‚¹ã‚³ã‚¢æ›´æ–°
            document.getElementById('currentScore').textContent = this.score;
            
            console.log(`ğŸ“Š ç¾åœ¨ã®ã‚¹ã‚³ã‚¢: ${this.score}/${this.currentQuestion}`);
        },
        
        getCorrectOptionText(correctOption) {
            const currentQuizCard = document.querySelector('.quiz-question:not([style*="display: none"])');
            if (!currentQuizCard) {
                // éè¡¨ç¤ºã«ãªã£ã¦ã„ã‚‹å ´åˆã¯ã€ç¾åœ¨ã®å•é¡Œç•ªå·ã‹ã‚‰å–å¾—
                const questionCard = document.querySelector(`[data-question-number="${this.currentQuestion}"]`);
                if (questionCard) {
                    const optionBtn = questionCard.querySelector(`[data-option="${correctOption}"]`);
                    return optionBtn ? optionBtn.textContent.trim() : 'ä¸æ˜';
                }
                return 'ä¸æ˜';
            }
            
            const optionBtn = currentQuizCard.querySelector(`[data-option="${correctOption}"]`);
            return optionBtn ? optionBtn.textContent.trim() : 'ä¸æ˜';
        },
        
        nextQuestion() {
            console.log(`ğŸ“ nextQuestion called: current=${this.currentQuestion}, total=${this.totalQuestions}`);
            
            // çµæœã‚’éè¡¨ç¤º
            document.getElementById('resultContainer').style.display = 'none';
            
            if (this.currentQuestion >= this.totalQuestions) {
                // å…¨å•å®Œäº† - çµæœç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                console.log('ğŸ‰ ã‚¯ã‚¤ã‚ºå®Œäº†ï¼çµæœç”»é¢ã«ç§»å‹•');
                window.location.href = `/quiz/result/${this.videoId}/`;
                return;
            }
            
            // æ¬¡ã®å•é¡Œã‚’è¡¨ç¤º
            this.currentQuestion++;
            this.selectedOption = null;
            
            // ç¾åœ¨ã®å•é¡Œã‚’éè¡¨ç¤º
            document.querySelectorAll('.quiz-question').forEach(card => {
                card.style.display = 'none';
            });
            
            // æ¬¡ã®å•é¡Œã‚’è¡¨ç¤º
            const nextQuestionCard = document.querySelector(`[data-question-number="${this.currentQuestion}"]`);
            if (nextQuestionCard) {
                nextQuestionCard.style.display = 'block';
                
                // æ¬¡ã®å•é¡Œã®å›ç­”ãƒœã‚¿ãƒ³ã‚’åˆæœŸåŒ–
                const nextSubmitBtn = nextQuestionCard.querySelector('.submit-answer-btn');
                if (nextSubmitBtn) {
                    nextSubmitBtn.disabled = true;
                    nextSubmitBtn.innerHTML = '<i class="fas fa-check me-2"></i>å›ç­”ã™ã‚‹';
                }
            }
            
            // UIæ›´æ–°
            this.updateProgress();
            document.getElementById('quizContainer').style.display = 'block';
            
            console.log(`â¡ï¸ å•é¡Œ ${this.currentQuestion} ã«é€²è¡Œ`);
        },
        
        updateProgress() {
            const progress = ((this.currentQuestion - 1) / this.totalQuestions) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('questionCounter').textContent = `${this.currentQuestion} / ${this.totalQuestions}`;
            document.getElementById('remainingQuestions').textContent = this.totalQuestions - this.currentQuestion + 1;
        }
    };
    
    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
        QuizManager.init();
    });
    </script>
</body>
</html>