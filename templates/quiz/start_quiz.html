<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÇØ„Ç§„Ç∫ÂÆüË°å - StudyBoost</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .question-card {
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 15px;
        }
        .option-btn {
            width: 100%;
            text-align: left;
            padding: 15px 20px;
            margin-bottom: 10px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .option-btn:hover {
            border-color: #007bff;
            background: #f8f9ff;
            transform: translateY(-2px);
        }
        .option-btn.selected {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }
        .progress-custom {
            height: 8px;
            border-radius: 10px;
        }
        .quiz-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        .submit-answer-btn {
            transition: all 0.3s ease;
        }
        .submit-answer-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <div class="quiz-container">
            <!-- „Éò„ÉÉ„ÉÄ„Éº -->
            <div class="card question-card mb-4">
                <div class="card-header quiz-header text-center py-4">
                    <h3 class="mb-2">
                        <i class="fas fa-question-circle me-2"></i>
                        „ÇØ„Ç§„Ç∫„ÉÅ„É£„É¨„É≥„Ç∏
                    </h3>
                    <h6 class="mb-0 opacity-75">{{ video.title }}</h6>
                </div>
                <div class="card-body">
                    <!-- ÈÄ≤Êçó„Éê„Éº -->
                    <div class="row align-items-center mb-3">
                        <div class="col-8">
                            <div class="progress progress-custom">
                                <div class="progress-bar bg-success" 
                                     role="progressbar" 
                                     style="width: 0%" 
                                     id="progressBar">
                                </div>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <span class="badge bg-primary fs-6" id="questionCounter">
                                1 / {{ total_questions }}
                            </span>
                        </div>
                    </div>
                    
                    <!-- „Çπ„Ç≥„Ç¢Ë°®Á§∫ -->
                    <div class="text-center">
                        <span class="badge bg-success me-2">
                            <i class="fas fa-star me-1"></i>
                            „Çπ„Ç≥„Ç¢: <span id="currentScore">0</span>
                        </span>
                        <span class="badge bg-info">
                            <i class="fas fa-clock me-1"></i>
                            ÊÆã„Çä: <span id="remainingQuestions">{{ total_questions }}</span>Âïè
                        </span>
                    </div>
                </div>
            </div>

            <!-- „ÇØ„Ç§„Ç∫ÂïèÈ°å„Ç®„É™„Ç¢ -->
            <div id="quizContainer">
                {% for quiz in quizzes %}
                <div class="card question-card quiz-question" 
                     data-quiz-id="{{ quiz.id }}" 
                     data-question-number="{{ forloop.counter }}"
                     style="{% if not forloop.first %}display: none;{% endif %}">
                    
                    <div class="card-body p-4">
                        <!-- ÂïèÈ°åÁï™Âè∑ -->
                        <div class="text-center mb-3">
                            <span class="badge bg-warning text-dark fs-6">
                                ÂïèÈ°å {{ forloop.counter }}
                            </span>
                        </div>
                        
                        <!-- ÂïèÈ°åÊñá -->
                        <h5 class="card-title text-center mb-4 fw-bold">
                            {{ quiz.question }}
                        </h5>
                        
                        <!-- ÈÅ∏ÊäûËÇ¢ -->
                        <div class="options-container">
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <button class="btn option-btn" data-option="1">
                                        <span class="fw-bold me-2">A.</span>
                                        {{ quiz.option_1 }}
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button class="btn option-btn" data-option="2">
                                        <span class="fw-bold me-2">B.</span>
                                        {{ quiz.option_2 }}
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button class="btn option-btn" data-option="3">
                                        <span class="fw-bold me-2">C.</span>
                                        {{ quiz.option_3 }}
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button class="btn option-btn" data-option="4">
                                        <span class="fw-bold me-2">D.</span>
                                        {{ quiz.option_4 }}
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ÂõûÁ≠î„Éú„Çø„É≥Ôºà„É¶„Éã„Éº„ÇØ„Å™„ÇØ„É©„ÇπÂêç„Çí‰ΩøÁî®Ôºâ -->
                        <div class="text-center mt-4">
                            <button class="btn btn-primary btn-lg px-5 submit-answer-btn" 
                                    data-question-id="{{ forloop.counter }}"
                                    disabled>
                                <i class="fas fa-check me-2"></i>
                                ÂõûÁ≠î„Åô„Çã
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- ÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢ -->
            <div id="resultContainer" style="display: none;">
                <div class="card question-card">
                    <div class="card-body text-center p-5">
                        <div id="resultIcon" class="mb-3">
                            <!-- „Ç¢„Ç§„Ç≥„É≥„ÅåÂãïÁöÑ„Å´ÊåøÂÖ•„Åï„Çå„Åæ„Åô -->
                        </div>
                        <h4 id="resultTitle" class="mb-3"></h4>
                        <p id="resultExplanation" class="text-muted mb-4"></p>
                        <button class="btn btn-success btn-lg" id="nextQuestion">
                            <i class="fas fa-arrow-right me-2"></i>
                            <span id="nextBtnText">Ê¨°„ÅÆÂïèÈ°å„Å∏</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ÂÆå‰∫Ü„Éú„Çø„É≥ -->
            <div class="text-center mt-4">
                <a href="/accounts/dashboard/" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã
                </a>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% csrf_token %}
    
    <script>
    // „ÇØ„Ç§„Ç∫ÁÆ°ÁêÜ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
    const QuizManager = {
        currentQuestion: 1,
        totalQuestions: {{ total_questions }},
        score: 0,
        selectedOption: null,
        videoId: {{ video.id }},
        
        init() {
            console.log('üéØ „ÇØ„Ç§„Ç∫ÈñãÂßã - Á∑èÂïèÈ°åÊï∞:', this.totalQuestions);
            this.bindEvents();
            this.updateProgress();
        },
        
        bindEvents() {
            // „Ç§„Éô„É≥„ÉàÂßîË≠≤„Çí‰ΩøÁî®
            document.addEventListener('click', (e) => {
                // ÈÅ∏ÊäûËÇ¢„ÇØ„É™„ÉÉ„ÇØ
                if (e.target.classList.contains('option-btn') || e.target.closest('.option-btn')) {
                    const optionBtn = e.target.classList.contains('option-btn') 
                        ? e.target 
                        : e.target.closest('.option-btn');
                    this.selectOption(optionBtn);
                }
                
                // ÂõûÁ≠î„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÔºà„ÇØ„É©„ÇπÂêç„ÅßÂà§ÂÆöÔºâ
                if (e.target.classList.contains('submit-answer-btn') || e.target.closest('.submit-answer-btn')) {
                    e.preventDefault();
                    this.submitAnswer();
                }
                
                // Ê¨°„ÅÆÂïèÈ°å„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ
                if (e.target.id === 'nextQuestion' || e.target.closest('#nextQuestion')) {
                    e.preventDefault();
                    this.nextQuestion();
                }
            });
        },
        
        selectOption(optionBtn) {
            // ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆÂïèÈ°å„ÅÆÈÅ∏ÊäûËÇ¢„ÅÆ„Åø„ÇíÂØæË±°„Å´„Åô„Çã
            const currentQuizCard = document.querySelector('.quiz-question:not([style*="display: none"])');
            if (!currentQuizCard) return;
            
            const currentOptions = currentQuizCard.querySelectorAll('.option-btn');
            
            // ÁèæÂú®„ÅÆÂïèÈ°å„ÅÆÈÅ∏ÊäûËÇ¢„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            currentOptions.forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Êñ∞„Åó„ÅÑÈÅ∏Êäû„ÇíË®≠ÂÆö
            optionBtn.classList.add('selected');
            this.selectedOption = optionBtn.dataset.option;
            
            // ÁèæÂú®„ÅÆÂïèÈ°å„ÅÆÂõûÁ≠î„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
            const currentSubmitBtn = currentQuizCard.querySelector('.submit-answer-btn');
            if (currentSubmitBtn) {
                currentSubmitBtn.disabled = false;
            }
            
            console.log('‚úÖ ÈÅ∏ÊäûËÇ¢ÈÅ∏Êäû:', this.selectedOption);
        },
        
        async submitAnswer() {
            if (!this.selectedOption) {
                alert('ÈÅ∏ÊäûËÇ¢„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const currentQuizCard = document.querySelector('.quiz-question:not([style*="display: none"])');
            if (!currentQuizCard) return;
            
            const quizId = currentQuizCard.dataset.quizId;
            
            // ÂõûÁ≠î„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñÔºàÈÄ£Á∂ö„ÇØ„É™„ÉÉ„ÇØÈò≤Ê≠¢Ôºâ
            const submitBtn = currentQuizCard.querySelector('.submit-answer-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ÈÄÅ‰ø°‰∏≠...';
            }
            
            console.log('üì§ ÂõûÁ≠îÈÄÅ‰ø°:', { quizId, selectedOption: this.selectedOption });
            
            try {
                const response = await fetch(`/quiz/submit/${this.videoId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        quiz_id: quizId,
                        selected_option: this.selectedOption
                    })
                });
                
                const data = await response.json();
                console.log('üì• ÂõûÁ≠îÁµêÊûú:', data);
                
                if (data.success) {
                    this.showResult(data);
                } else {
                    alert('„Ç®„É©„Éº: ' + data.error);
                    // „Ç®„É©„ÉºÊôÇ„ÅØ„Éú„Çø„É≥„ÇíÂæ©ÂÖÉ
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>ÂõûÁ≠î„Åô„Çã';
                    }
                }
                
            } catch (error) {
                console.error('‚ùå ÂõûÁ≠îÈÄÅ‰ø°„Ç®„É©„Éº:', error);
                alert('ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                // „Ç®„É©„ÉºÊôÇ„ÅØ„Éú„Çø„É≥„ÇíÂæ©ÂÖÉ
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>ÂõûÁ≠î„Åô„Çã';
                }
            }
        },
        
        showResult(data) {
            console.log('üìä ÁµêÊûúË°®Á§∫:', data);
            
            // ÂïèÈ°å„ÇíÈùûË°®Á§∫
            document.getElementById('quizContainer').style.display = 'none';
            
            // ÁµêÊûú„ÇíË°®Á§∫
            const resultContainer = document.getElementById('resultContainer');
            const resultIcon = document.getElementById('resultIcon');
            const resultTitle = document.getElementById('resultTitle');
            const resultExplanation = document.getElementById('resultExplanation');
            const nextBtnText = document.getElementById('nextBtnText');
            
            if (data.is_correct) {
                resultIcon.innerHTML = '<i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>';
                resultTitle.innerHTML = '<span class="text-success">Ê≠£Ëß£ÔºÅ</span>';
                resultTitle.className = 'mb-3 text-success';
                this.score++;
            } else {
                resultIcon.innerHTML = '<i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>';
                resultTitle.innerHTML = '<span class="text-danger">‰∏çÊ≠£Ëß£</span>';
                resultTitle.className = 'mb-3 text-danger';
                
                // Ê≠£Ëß£„ÅÆÈÅ∏ÊäûËÇ¢„ÇíË°®Á§∫
                const correctOptionText = this.getCorrectOptionText(data.correct_option);
                resultTitle.innerHTML += `<br><small class="text-muted">Ê≠£Ëß£: ${correctOptionText}</small>`;
            }
            
            resultExplanation.textContent = data.explanation;
            
            // ÊúÄÂæå„ÅÆÂïèÈ°å„Åã„Å©„ÅÜ„Åã„Åß„Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÂ§âÊõ¥
            if (this.currentQuestion >= this.totalQuestions) {
                nextBtnText.innerHTML = '<i class="fas fa-trophy me-2"></i>ÁµêÊûú„ÇíË¶ã„Çã';
            } else {
                nextBtnText.innerHTML = 'Ê¨°„ÅÆÂïèÈ°å„Å∏';
            }
            
            resultContainer.style.display = 'block';
            
            // „Çπ„Ç≥„Ç¢Êõ¥Êñ∞
            document.getElementById('currentScore').textContent = this.score;
            
            console.log(`üìä ÁèæÂú®„ÅÆ„Çπ„Ç≥„Ç¢: ${this.score}/${this.currentQuestion}`);
        },
        
        getCorrectOptionText(correctOption) {
            const currentQuizCard = document.querySelector('.quiz-question:not([style*="display: none"])');
            if (!currentQuizCard) {
                // ÈùûË°®Á§∫„Å´„Å™„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅÁèæÂú®„ÅÆÂïèÈ°åÁï™Âè∑„Åã„ÇâÂèñÂæó
                const questionCard = document.querySelector(`[data-question-number="${this.currentQuestion}"]`);
                if (questionCard) {
                    const optionBtn = questionCard.querySelector(`[data-option="${correctOption}"]`);
                    return optionBtn ? optionBtn.textContent.trim() : '‰∏çÊòé';
                }
                return '‰∏çÊòé';
            }
            
            const optionBtn = currentQuizCard.querySelector(`[data-option="${correctOption}"]`);
            return optionBtn ? optionBtn.textContent.trim() : '‰∏çÊòé';
        },
        
        nextQuestion() {
            console.log(`üìç nextQuestion called: current=${this.currentQuestion}, total=${this.totalQuestions}`);
            
            // ÁµêÊûú„ÇíÈùûË°®Á§∫
            document.getElementById('resultContainer').style.display = 'none';
            
            if (this.currentQuestion >= this.totalQuestions) {
                // ÂÖ®ÂïèÂÆå‰∫Ü - ÁµêÊûúÁîªÈù¢„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
                console.log('üéâ „ÇØ„Ç§„Ç∫ÂÆå‰∫ÜÔºÅÁµêÊûúÁîªÈù¢„Å´ÁßªÂãï');
                window.location.href = `/quiz/result/${this.videoId}/`;
                return;
            }
            
            // Ê¨°„ÅÆÂïèÈ°å„ÇíË°®Á§∫
            this.currentQuestion++;
            this.selectedOption = null;
            
            // ÁèæÂú®„ÅÆÂïèÈ°å„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.quiz-question').forEach(card => {
                card.style.display = 'none';
            });
            
            // Ê¨°„ÅÆÂïèÈ°å„ÇíË°®Á§∫
            const nextQuestionCard = document.querySelector(`[data-question-number="${this.currentQuestion}"]`);
            if (nextQuestionCard) {
                nextQuestionCard.style.display = 'block';
                
                // Ê¨°„ÅÆÂïèÈ°å„ÅÆÂõûÁ≠î„Éú„Çø„É≥„ÇíÂàùÊúüÂåñ
                const nextSubmitBtn = nextQuestionCard.querySelector('.submit-answer-btn');
                if (nextSubmitBtn) {
                    nextSubmitBtn.disabled = true;
                    nextSubmitBtn.innerHTML = '<i class="fas fa-check me-2"></i>ÂõûÁ≠î„Åô„Çã';
                }
            }
            
            // UIÊõ¥Êñ∞
            this.updateProgress();
            document.getElementById('quizContainer').style.display = 'block';
            
            console.log(`‚û°Ô∏è ÂïèÈ°å ${this.currentQuestion} „Å´ÈÄ≤Ë°å`);
        },
        
        updateProgress() {
            const progress = ((this.currentQuestion - 1) / this.totalQuestions) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('questionCounter').textContent = `${this.currentQuestion} / ${this.totalQuestions}`;
            document.getElementById('remainingQuestions').textContent = this.totalQuestions - this.currentQuestion + 1;
        }
    };
    
    // ÂàùÊúüÂåñ
    document.addEventListener('DOMContentLoaded', () => {
        QuizManager.init();
    });
    </script>
</body>
</html>